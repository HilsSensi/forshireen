<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Uang Jajan | Filter Kategori Tambahan üí∞</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        :root {
            /* Warna Palet */
            --color-primary: #3498db; /* Biru */
            --color-success: #2ecc71; /* Hijau */
            --color-danger: #e74c3c; /* Merah */
            --color-warning: #f39c12; /* Kuning */
            --color-cash: #40c0cb; /* Cyan untuk Saldo Kas */
            --color-dana: #9b59b6; /* Ungu untuk Saldo Dana */
            --color-background: #f0f4f8;
            --color-text: #2c3e50;
            --color-white: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background); 
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 750px; 
            margin: 0 auto;
            padding: 20px 15px; 
            background-color: var(--color-white);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            color: var(--color-primary); 
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.8em;
        }
        
        h2 {
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        hr {
            border: none;
            height: 1px;
            background: #ecf0f1;
            margin: 25px 0;
        }

        /* --- Saran Keuangan Cerdas (AI Advice Box) --- */
        .advice-box {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff3cd; 
            border: 1px solid #ffeeba;
            color: #856404;
            display: none; 
            font-size: 0.9em;
        }
        
        .advice-box strong {
            color: var(--color-text);
        }
        
        .advice-box ul {
            margin-top: 8px;
            padding-left: 20px;
        }

        /* --- Kartu Ringkasan (Responsive Grid) --- */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            color: var(--color-white);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        
        .income-card { background: linear-gradient(45deg, var(--color-success), #27ae60); }
        .expense-card { background: linear-gradient(45deg, var(--color-danger), #c0392b); }
        .cash-card { background: linear-gradient(45deg, var(--color-cash), #39a8b1); }
        .dana-card { background: linear-gradient(45deg, var(--color-dana), #8e44ad); }
        
        .total-card {
            background: linear-gradient(45deg, var(--color-primary), #2980b9);
        }
        
        .total-card.critical {
             background: linear-gradient(45deg, var(--color-warning), #d8890e);
        }

        .card h3 { margin-top: 0; font-size: 0.8em; opacity: 0.9; }
        .card p { font-size: 1.4em; font-weight: 700; margin-bottom: 0; }

        /* --- Form Transaksi --- */
        .transaction-form {
            padding: 20px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            background: #fdfdfd;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-direction: column; 
        }
        
        .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 0.9em; }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-direction: column; 
        }

        .button-group button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        .btn-income { background-color: var(--color-success); color: var(--color-white); }
        .btn-expense { background-color: var(--color-danger); color: var(--color-white); }
        .btn-quick { background-color: var(--color-warning); color: var(--color-white); }
        .btn-transfer { background-color: var(--color-primary); color: var(--color-white); }

        .btn-income:hover { background-color: #27ae60; }
        .btn-expense:hover { background-color: #c0392b; }
        .btn-quick:hover { background-color: #d8890e; }
        .btn-transfer:hover { background-color: #2980b9; }

        /* --- Riwayat Transaksi --- */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Menggunakan grid untuk filter */
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-controls label {
            font-weight: 600;
            font-size: 0.9em;
        }

        .filter-controls select, .filter-controls input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }

        .history-table-container {
            overflow-x: auto;
        }

        #transactionTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }

        #transactionTable th, #transactionTable td {
            padding: 12px 10px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            font-size: 0.85em; 
        }

        #transactionTable th {
            background-color: var(--color-primary);
            color: var(--color-white);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .income-row { color: #27ae60; }
        .expense-row { color: #c0392b; }
        
        /* Responsive Breakpoints */
        @media (min-width: 600px) {
            .container { padding: 30px 25px; max-width: 1000px; }
            .form-row { flex-direction: row; }
            .button-group { flex-direction: row; }
            .button-group button { width: auto; }
            
            .filter-controls {
                 grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Catatan Uang Jajan Pintar</h1>

        <div id="adviceBox" class="advice-box">
            <strong>Saran Keuangan Cerdas dari AI ü§ñ</strong>
            <p id="adviceMessage">Analisis sedang berjalan...</p>
        </div>

        <section class="summary-section">
            <h2>Ringkasan Saldo Saat Ini</h2>
            <div class="summary-cards">
                <div class="card income-card">
                    <h3>Pemasukan Total</h3>
                    <p id="totalIncome">Rp0</p>
                </div>
                <div class="card expense-card">
                    <h3>Pengeluaran Total</h3>
                    <p id="totalExpense">Rp0</p>
                </div>
                <div class="card cash-card">
                    <h3>Saldo Kas (Cash)</h3>
                    <p id="currentCash">Rp0</p>
                </div>
                <div class="card dana-card">
                    <h3>Saldo Dana (E-Wallet)</h3>
                    <p id="currentDana">Rp0</p>
                </div>
                <div id="balanceCard" class="card total-card">
                    <h3>Total Saldo (Semua)</h3>
                    <p id="grandTotalBalance">Rp0</p>
                </div>
            </div>
        </section>

        <hr>

        <section class="transaction-form">
            <h2>Tambah Transaksi / Pindah Saldo</h2>
            <form id="transactionForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionDate">Tanggal Transaksi:</label>
                        <input type="date" id="transactionDate" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Keterangan:</label>
                        <input type="text" id="description" placeholder="Misal: Beli makan siang / Pindah ke Dana" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">Jumlah (Rp):</label>
                        <input type="number" id="amount" min="1" required>
                    </div>
                    <div class="form-group" id="accountGroup">
                        <label for="sourceAccount">Sumber Saldo:</label>
                        <select id="sourceAccount">
                            <option value="Cash">Kas (Cash)</option>
                            <option value="Dana">Dana (E-Wallet)</option>
                        </select>
                        <div id="targetAccountGroup" style="margin-top: 10px; display:none;">
                            <label for="targetAccount">Tujuan Saldo:</label>
                            <select id="targetAccount">
                                <option value="Dana">Dana (E-Wallet)</option>
                                <option value="Cash">Kas (Cash)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="categoryGroup">
                        <label for="category">Kategori Pengeluaran (Wajib jika Pengeluaran):</label>
                        <select id="category">
                            <option value="">Pilih Kategori...</option>
                            <option value="Makanan">Makanan & Minuman</option>
                            <option value="Transportasi">Transportasi</option>
                            <option value="Edukasi">Edukasi/Peralatan</option>
                            <option value="Hiburan">Hiburan</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" id="btnIncome" class="btn-income" data-mode="income">üì• + Pemasukan</button>
                    <button type="submit" id="btnExpense" class="btn-expense" data-mode="expense">üì§ - Pengeluaran</button>
                    <button type="button" id="btnTransfer" class="btn-transfer" data-mode="transfer">üîÑ Pindah Saldo</button>
                    <button type="button" id="btnQuickIncome" class="btn-quick">‚ûï Rp30.000 (Jajan Sekolah)</button>
                </div>
            </form>
        </section>

        <hr>

        <section class="history">
            <h2>Riwayat Transaksi</h2>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="filterTime">Filter Waktu:</label>
                    <select id="filterTime">
                        <option value="all">Semua</option>
                        <option value="today">Hari Ini</option>
                        <option value="this-week">Minggu Ini (7 Hari Terakhir)</option>
                        <option value="this-month">Bulan Ini</option>
                        <option value="date-range">Rentang Tanggal Custom</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterCategory">Filter Kategori:</label>
                    <select id="filterCategory">
                        <option value="all">Semua Kategori</option>
                        <option value="Makanan">Makanan & Minuman</option>
                        <option value="Transportasi">Transportasi</option>
                        <option value="Edukasi">Edukasi/Peralatan</option>
                        <option value="Hiburan">Hiburan</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                </div>

                <div class="filter-group" id="dateRangeInputs" style="display:none; grid-column: span 2;">
                    <label>Rentang Tanggal:</label>
                    <div style="display:flex; gap: 5px;">
                        <input type="date" id="startDate" style="flex: 1;">
                        <input type="date" id="endDate" style="flex: 1;">
                    </div>
                </div>
            </div>

            <div class="history-table-container">
                <table id="transactionTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Jenis</th>
                            <th>Jumlah</th>
                            <th>Sumber/Tujuan</th>
                            <th>Keterangan</th>
                            <th>Kategori</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList">
                        </tbody>
                </table>
                <p id="noTransactions" style="text-align: center; margin-top: 20px;">Belum ada transaksi.</p>
            </div>
        </section>

        <hr>

        <footer class="motivation">
            <blockquote id="quoteText">Memuat motivasi terbaik...</blockquote>
            <cite id="quoteAuthor">Tokoh Sukses</cite>
        </footer>
    </div>

    <script>
        let transactions = [];
        const STORAGE_KEY = 'uangJajanTransactionsV4';
        
        // --- DATA MOTIVASI ---
        const MOTIVATIONS = [
            { quote: "Cara untuk memulai adalah berhenti berbicara dan mulai melakukan.", author: "Walt Disney" },
            { quote: "Keberanian adalah harga yang dituntut kehidupan untuk memberikan kedamaian.", author: "Amelia Earhart" },
            { quote: "Rahasia untuk maju adalah memulai.", author: "Mark Twain" },
            { quote: "Anda tidak dapat menghabiskan jalan menuju kekayaan.", author: "Suze Orman (Pakar Keuangan)" },
            { quote: "Jangan biarkan uang menjadi raja, buat uang menjadi budak.", author: "P.T. Barnum" },
            { quote: "Jangan pernah menginvestasikan dalam bisnis yang tidak Anda pahami.", author: "Warren Buffett" },
            { quote: "Investasi terbaik yang dapat Anda lakukan adalah pada diri Anda sendiri. Semakin banyak Anda belajar, semakin banyak Anda hasilkan.", author: "Warren Buffett" },
            { quote: "Jangan menabung apa yang tersisa setelah dibelanjakan, tetapi belanjakan apa yang tersisa setelah menabung.", author: "Warren Buffett" },
            { quote: "Jika Anda tidak membangun mimpi Anda sendiri, seseorang akan mempekerjakan Anda untuk membangun mimpi mereka.", author: "Dhirubhai Ambani" }
        ];

        // --- Fungsi Utilitas ---

        function loadTransactions() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                transactions = JSON.parse(storedData).map(t => ({
                    ...t,
                    date: new Date(t.date) 
                }));
            } else {
                transactions = [];
            }
        }

        function saveTransactions() {
            const serializableTransactions = transactions.map(t => ({
                ...t,
                date: t.date.toISOString()
            }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serializableTransactions));
        }

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function displayRandomMotivation() {
            const index = Math.floor(Math.random() * MOTIVATIONS.length);
            const quoteData = MOTIVATIONS[index];
            
            document.getElementById('quoteText').textContent = `"${quoteData.quote}"`;
            document.getElementById('quoteAuthor').textContent = `- ${quoteData.author} üí°`;
        }

        function showFinancialAdvice(totalIncome, totalExpense, currentBalance) {
            const adviceBox = document.getElementById('adviceBox');
            const adviceMessage = document.getElementById('adviceMessage');
            const balanceCard = document.getElementById('balanceCard');
            
            const CRITICAL_BALANCE_THRESHOLD = 50000; 
            const EXPENSE_RATIO_THRESHOLD = 0.70;
            
            let expenseRatio = 0;
            if (totalIncome > 0) {
                expenseRatio = totalExpense / totalIncome;
            }
            
            adviceBox.style.display = 'none';
            adviceBox.style.backgroundColor = '#fff3cd'; 
            adviceBox.style.borderColor = '#ffeeba';
            balanceCard.classList.remove('critical');

            if (currentBalance < 0) {
                adviceBox.style.display = 'block';
                balanceCard.classList.add('critical');
                adviceMessage.innerHTML = `<p>üö® **PERHATIAN: Saldo Anda saat ini negatif!** Pengeluaran melebihi pemasukan total Anda. Segera lakukan langkah koreksi.</p><ul><li>**Tinjau Kembali:** Cek riwayat.</li><li>**Prioritaskan Pemasukan:** Cari peluang untuk segera **menambah penghasilan**.</li></ul>`;
            } else if (currentBalance <= CRITICAL_BALANCE_THRESHOLD && totalIncome > 0) {
                adviceBox.style.display = 'block';
                balanceCard.classList.add('critical');
                adviceMessage.innerHTML = `<p>‚ö†Ô∏è **Saldo Kritis!** Saldo Anda tinggal ${formatRupiah(currentBalance)}. Angka ini sangat tipis.</p><ul><li>**Kendalikan Belanja:** Tunda semua pengeluaran yang tidak wajib.</li><li>**Peluang Penghasilan:** Pertimbangkan pekerjaan singkat (micro-jobs) atau proyek kecil untuk *booster* saldo.</li></ul>`;
            } else if (expenseRatio >= EXPENSE_RATIO_THRESHOLD) {
                adviceBox.style.display = 'block';
                adviceBox.style.backgroundColor = '#d1ecf1';
                adviceBox.style.borderColor = '#bee5eb';
                adviceMessage.innerHTML = `<p>üìà **Waspada!** Pengeluaran Anda sudah mencapai ${Math.round(expenseRatio * 100)}% dari total pemasukan. Ini kurang ideal untuk tabungan.</p><ul><li>**Identifikasi Pemborosan:** Analisis riwayat Anda. Coba kurangi 10% dari pengeluaran terbesar Anda.</li><li>**Inisiatif Penghasilan:** Coba **ide penghasilan sampingan** untuk stabilitas.</li></ul>`;
            }
        }

        // --- Logika Inti Aplikasi ---

        function calculateSummary() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalCash = 0;
            let totalDana = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    if (t.sourceAccount === 'Cash') {
                        totalCash += t.amount;
                    } else if (t.sourceAccount === 'Dana') {
                        totalDana += t.amount;
                    }
                } else if (t.type === 'expense') {
                    totalExpense += t.amount;
                    if (t.sourceAccount === 'Cash') {
                        totalCash -= t.amount;
                    } else if (t.sourceAccount === 'Dana') {
                        totalDana -= t.amount;
                    }
                } else if (t.type === 'transfer') {
                    // Transfer: Keluar dari sumber, masuk ke tujuan
                    if (t.sourceAccount === 'Cash') {
                        totalCash -= t.amount; 
                        totalDana += t.amount; 
                    } else if (t.sourceAccount === 'Dana') {
                        totalDana -= t.amount; 
                        totalCash += t.amount; 
                    }
                }
            });

            const grandTotalBalance = totalCash + totalDana;

            // Update UI Ringkasan
            document.getElementById('totalIncome').textContent = formatRupiah(totalIncome);
            document.getElementById('totalExpense').textContent = formatRupiah(totalExpense);
            document.getElementById('currentCash').textContent = formatRupiah(totalCash);
            document.getElementById('currentDana').textContent = formatRupiah(totalDana);
            document.getElementById('grandTotalBalance').textContent = formatRupiah(grandTotalBalance);
            
            showFinancialAdvice(totalIncome, totalExpense, grandTotalBalance);
        }

        /**
         * REVISI: Menerapkan Filter Kategori selain Filter Waktu.
         */
        function renderTransactions() {
            const filterTime = document.getElementById('filterTime').value;
            const filterCategory = document.getElementById('filterCategory').value; // Ambil nilai filter kategori
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const listElement = document.getElementById('transactionList');
            const noTransactionsElement = document.getElementById('noTransactions');
            listElement.innerHTML = '';
            
            let filteredTransactions = [...transactions];
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            // 1. Terapkan Filter Waktu
            switch (filterTime) {
                case 'today':
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date.toDateString() === now.toDateString()
                    );
                    break;
                case 'this-week':
                    const sevenDaysAgo = new Date(now);
                    sevenDaysAgo.setDate(now.getDate() - 6);
                    filteredTransactions = filteredTransactions.filter(t => 
                        t.date >= sevenDaysAgo && t.date <= now
                    );
                    break;
                case 'this-month':
                    filteredTransactions = filteredTransactions.filter(t => {
                        return t.date.getMonth() === now.getMonth() && t.date.getFullYear() === now.getFullYear();
                    });
                    break;
                case 'date-range':
                    const start = startDateInput.value ? new Date(startDateInput.value) : null;
                    const end = endDateInput.value ? new Date(endDateInput.value) : null;

                    if (start && end) {
                        end.setHours(23, 59, 59, 999); 
                        filteredTransactions = filteredTransactions.filter(t => 
                            t.date >= start && t.date <= end
                        );
                    }
                    break;
                case 'all':
                default:
                    break;
            }
            
            // 2. Terapkan Filter Kategori
            if (filterCategory !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => {
                    // Hanya tampilkan transaksi yang merupakan pengeluaran DAN cocok dengan kategori
                    // atau yang memiliki jenis transaksi 'expense'
                    return t.type === 'expense' && t.category === filterCategory;
                });
            }

            
            filteredTransactions.sort((a, b) => b.date - a.date);

            if (filteredTransactions.length === 0) {
                noTransactionsElement.style.display = 'block';
            } else {
                noTransactionsElement.style.display = 'none';
            }

            filteredTransactions.forEach(t => {
                const row = document.createElement('tr');
                let typeText;
                let amountSign;
                let categoryDisplay = t.category || '-';
                let sourceTargetDisplay;

                if (t.type === 'income') {
                    row.classList.add('income-row');
                    typeText = 'Pemasukan';
                    amountSign = '+';
                    sourceTargetDisplay = `Ke: ${t.sourceAccount}`;
                } else if (t.type === 'expense') {
                    row.classList.add('expense-row');
                    typeText = 'Pengeluaran';
                    amountSign = '-';
                    sourceTargetDisplay = `Dari: ${t.sourceAccount}`;
                } else if (t.type === 'transfer') {
                    row.classList.add('total-card'); 
                    row.style.color = 'var(--color-primary)';
                    typeText = 'Pindah Saldo';
                    amountSign = '';
                    sourceTargetDisplay = `${t.sourceAccount} ‚Üí ${t.targetAccount}`;
                    categoryDisplay = '-';
                }

                const formattedDate = t.date.toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${typeText}</td>
                    <td>${amountSign}${formatRupiah(t.amount).replace('Rp', '')}</td>
                    <td>${sourceTargetDisplay}</td>
                    <td>${t.description}</td>
                    <td>${categoryDisplay}</td>
                    <td><button class="delete-btn" data-id="${t.id}">Hapus</button></td>
                `;
                listElement.appendChild(row);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    deleteTransaction(this.dataset.id);
                });
            });
        }

        function addTransaction(amount, description, type, dateString, sourceAccount, category, targetAccount = null) {
            const newTransaction = {
                id: Date.now(),
                amount: amount,
                description: description,
                type: type,
                date: new Date(dateString),
                sourceAccount: sourceAccount,
                targetAccount: targetAccount, 
                category: type === 'expense' ? category : null 
            };

            transactions.push(newTransaction);
            saveTransactions();
            calculateSummary(); 
            renderTransactions(); 

            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('category').value = '';
            document.getElementById('transactionDate').value = getTodayDateString();
        }

        function deleteTransaction(id) {
            const transactionId = parseInt(id, 10);
            
            transactions = transactions.filter(t => t.id !== transactionId);
            
            saveTransactions();
            calculateSummary();
            renderTransactions();
        }

        // --- Event Listeners ---
        
        // Fungsi untuk mengontrol tampilan input di form
        function toggleFormInputs(mode) {
            const targetGroup = document.getElementById('targetAccountGroup');
            const categoryGroup = document.getElementById('categoryGroup');
            
            if (mode === 'transfer') {
                targetGroup.style.display = 'block';
                categoryGroup.style.display = 'none';
                document.getElementById('description').placeholder = 'Misal: Pindah dari Kas ke Dana';
            } else {
                targetGroup.style.display = 'none';
                categoryGroup.style.display = 'block';
                document.getElementById('description').placeholder = 'Misal: Beli makan siang';
            }
        }

        // Listener untuk Tombol Pindah Saldo (Transfer)
        document.getElementById('btnTransfer').addEventListener('click', function(event) {
            event.preventDefault();
            toggleFormInputs('transfer'); 
            
            const amount = parseInt(document.getElementById('amount').value, 10);
            const description = document.getElementById('description').value.trim();
            const dateString = document.getElementById('transactionDate').value;
            const source = document.getElementById('sourceAccount').value;
            const target = document.getElementById('targetAccount').value;

            if (!amount || amount <= 0 || !description || !dateString) {
                alert('Mohon isi Jumlah, Keterangan, dan Tanggal untuk Pindah Saldo.');
                return;
            }
            if (source === target) {
                alert('Sumber dan Tujuan Saldo tidak boleh sama.');
                return;
            }

            addTransaction(amount, description, 'transfer', dateString, source, null, target);
        });
        
        // Listener untuk Tombol Pemasukan/Pengeluaran
        document.getElementById('transactionForm').addEventListener('submit', function(event) {
            event.preventDefault(); 
            
            const submitterId = event.submitter.id;

            if (submitterId === 'btnTransfer') return; 

            toggleFormInputs('expense_or_income'); 

            const amount = parseInt(document.getElementById('amount').value, 10);
            const description = document.getElementById('description').value.trim();
            const dateString = document.getElementById('transactionDate').value;
            const sourceAccount = document.getElementById('sourceAccount').value;
            const category = document.getElementById('category').value;
            
            if (!amount || amount <= 0 || !description || !dateString) {
                alert('Mohon isi semua kolom (Jumlah, Keterangan, Tanggal) dengan benar.');
                return;
            }
            
            let type = '';
            if (submitterId === 'btnIncome' || submitterId === 'btnQuickIncome') {
                type = 'income';
            } else if (submitterId === 'btnExpense') {
                type = 'expense';
                if (!category) {
                    alert('Mohon pilih Kategori untuk Pengeluaran.');
                    return;
                }
            } else {
                return;
            }
            
            addTransaction(amount, description, type, dateString, sourceAccount, category);
        });

        // Tombol cepat "Jajan Sekolah"
        document.getElementById('btnQuickIncome').addEventListener('click', function() {
            toggleFormInputs('income');
            const amount = 30000;
            const description = 'Uang Jajan Sekolah';
            const dateString = document.getElementById('transactionDate').value || getTodayDateString(); 
            const sourceAccount = document.getElementById('sourceAccount').value; 
            
            addTransaction(amount, description, 'income', dateString, sourceAccount, null); 
        });
        
        // Tambahkan event listener untuk tombol Income dan Expense agar form toggle
        document.getElementById('btnIncome').addEventListener('click', () => toggleFormInputs('income'));
        document.getElementById('btnExpense').addEventListener('click', () => toggleFormInputs('expense'));
        
        // --- Event Listeners Filter Riwayat ---

        // Ganti event listener filter Waktu
        document.getElementById('filterTime').addEventListener('change', function() {
            const filterTime = this.value;
            const dateRangeInputs = document.getElementById('dateRangeInputs');
            
            if (filterTime === 'date-range') {
                dateRangeInputs.style.display = 'grid'; // Tampilkan input tanggal
            } else {
                dateRangeInputs.style.display = 'none'; // Sembunyikan input tanggal
                renderTransactions(); // Render ulang jika filter waktu non-custom berubah
            }
        });
        
        // Tambahkan event listener filter Kategori
        document.getElementById('filterCategory').addEventListener('change', renderTransactions);


        document.getElementById('startDate').addEventListener('change', renderTransactions);
        document.getElementById('endDate').addEventListener('change', renderTransactions);


        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', function() {
            displayRandomMotivation();
            
            const todayString = getTodayDateString();
            document.getElementById('transactionDate').value = todayString;
            document.getElementById('startDate').value = todayString;
            document.getElementById('endDate').value = todayString;
            
            loadTransactions();
            calculateSummary();
            renderTransactions();
            
            // Inisialisasi tampilan form
            toggleFormInputs('income');
        });
    </script>
</body>
</html>
